<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ルート表示（ローカルJSON＋訪問順マーカー）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body { font-family: "Noto Sans JP", system-ui, sans-serif; margin: 0; }
    #map { width: 100%; height: calc(100vh - 100px); }

    header {
      background: #f8f8f8;
      padding: 10px 16px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header label { font-size: 14px; margin-right: 0px; }
    header input, header select { padding: 4px 6px; font-size: 14px; }
    header button {
      background: #0078ff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    header button:hover { background: #005fcc; }
    
    .select-wrapper {
      width: 300px; /* 表示幅を指定 */
      overflow: hidden;
    }
    
    .select-wrapper select {
      width: 100%;
      text-overflow: ellipsis; /* 省略記号 */
      white-space: nowrap;      /* 折り返さない */
      overflow: hidden;
    }

    /* モーダル関連 */
    .modal {
      display: none; /* 初期は非表示 */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; /* スクロール可能にする */
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      max-width: 800px;
      border-radius: 8px;
      overflow-x: auto; /* 横スクロール対応 */
    }
    
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: #000; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    
    th {
      background-color: #f0f0f0;
    }
    
    #showDetailsBtn {
      background: #00aa55;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    #showDetailsBtn:hover {
      background: #008844; /* 暗くする */
    }

  </style>
</head>
<body>
  <header>
    <label>始点:</label>
    <div class="select-wrapper">
      <select id="start">
        <option value="富山市ガラス美術館">富山市ガラス美術館</option>
        <option value="黒部ダム">黒部ダム</option>
        <option value="瑞龍寺">瑞龍寺</option>
        <option value="雪の大谷">雪の大谷</option>
        <option value="富岩運河環水公園">富岩運河環水公園</option>
        <option value="越中五箇山相倉集落">越中五箇山相倉集落</option>
        <option value="富山県美術館">富山県美術館</option>
        <option value="氷見市潮風ギャラリー藤子不二雄Aアートコレクション">氷見市潮風ギャラリー藤子不二雄Aアートコレクション</option>
      </select>
    </div>

    <label>終点:</label>
    <div class="select-wrapper">
      <select id="end">
        <option value="富山市ガラス美術館">富山市ガラス美術館</option>
        <option value="黒部ダム">黒部ダム</option>
        <option value="瑞龍寺">瑞龍寺</option>
        <option value="雪の大谷">雪の大谷</option>
        <option value="富岩運河環水公園">富岩運河環水公園</option>
        <option value="越中五箇山相倉集落">越中五箇山相倉集落</option>
        <option value="富山県美術館">富山県美術館</option>
        <option value="氷見市潮風ギャラリー藤子不二雄Aアートコレクション">氷見市潮風ギャラリー藤子不二雄Aアートコレクション</option>
      </select>
    </div>

    <label>出発時刻:</label>
    <input type="time" id="startTime" value="08:00">

    <label>到着時刻:</label>
    <input type="time" id="endTime" value="18:00">
    
    <button id="preferenceBtn">嗜好パラメータ調整</button>
    <button id="showRouteBtn">ルートを計算して表示</button>
    <button id="showDetailsBtn">詳細表示</button>
    
  </header>

  <div id="map"></div>

  <!-- モーダル -->
  <!--詳細表示モーダル-->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ルート詳細</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>地点名</th>
              <th>滞在時間</th>
              <th>到着時間</th>
              <th>出発時間</th>
            </tr>
          </thead>
          <tbody id="routeDetailsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!--嗜好パラメータモーダル-->
  <div id="preferenceModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closePrefModal">&times;</span>
      <h2>嗜好パラメータ調整</h2>
      <div class="preference-slider">
        <label>自然・景観: <span id="pref1Value">1</span></label>
        <input type="range" id="pref1" min="1" max="3" step="1" value="1">
      </div>
      <div class="preference-slider">
        <label>歴史・文化: <span id="pref2Value">1</span></label>
        <input type="range" id="pref2" min="1" max="3" step="1" value="1">
      </div>
      <div class="preference-slider">
        <label>芸術・学び: <span id="pref3Value">1</span></label>
        <input type="range" id="pref3" min="1" max="3" step="1" value="1">
      </div>
      <div class="preference-slider">
        <label>食・買い物・体験: <span id="pref4Value">1</span></label>
        <input type="range" id="pref4" min="1" max="3" step="1" value="1">
      </div>
      <div class="preference-slider">
        <label>レジャー・癒し: <span id="pref5Value">1</span></label>
        <input type="range" id="pref5" min="1" max="3" step="1" value="1">
      </div>
      <button id="savePrefBtn" style="margin-top:12px;">保存</button>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    
    const tableData = [
      ["富岩運河環水公園", "30分", "08:00", "08:30"],
      ["↓", "20分", "", ""],
      ["富山市ガラス美術館", "45分", "08:50", "09:35"],
      ["↓", "10分", "", ""],
      ["瑞龍寺", "20分", "09:45", "10:05"],
      ["↓", "15分", "", ""],
      ["富山市科学博物館", "20分", "10:20", "10:40"],
      ["↓", "30分", "", ""],
      ["高岡大仏", "20分", "11:10", "11:30"],
    ];
    // 富山県中心 (緯度, 経度)
    const TOYAMA_CENTER = [36.6953, 137.2137];

    // マップ初期化
    const map = L.map('map', {
      center: TOYAMA_CENTER,
      zoom: 9,
      minZoom: 8,
      maxZoom: 16,
      zoomControl: true,
      tap: false,           // mobile tap誤検知を減らす
      inertia: true,
      preferCanvas: true    // パフォーマンス向上（大量描画時）
    });

    // OSMタイル（軽めのプロバイダを指定）
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    async function drawRouteOnMap(order) {
      ;
    }
    
    //経路計算
    function computeRoute(){
      console.log("現在の嗜好値:", preferenceValues);
      // preferenceValuesをルート計算の重みとして使用
      // 例: 自然・景観に重みをかけてスコア計算など
      const numbers = Array.from({ length: 78 }, (_, i) => i);
      const arr = [];
      const loca_num = Math.floor(Math.random() * 13) + 2;
      
      for (let i = 0; i < loca_num; i++) {
        const index = Math.floor(Math.random() * numbers.length);
        arr.push(numbers.splice(index, 1)[0]); // 重複しないように取り出す
      }
      console.log(arr);
      return arr;
    }
    
    //モーダルウィンドウに情報を挿入する関数
    function populateRouteTable(data) {//dataはstringの二次元配列
      const tbody = document.getElementById("routeDetailsBody");
      tbody.innerHTML = ""; // 古い内容をクリア
    
      data.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // --- ボタンイベント ---
    document.getElementById("showRouteBtn").addEventListener("click", () => {
      const computed_routes = computeRoute();
      drawRouteOnMap(computed_routes);
      //drawRouteOnMap([1, 2, 3, 4, 5]);
    });

    // === モーダル専用の処理 ===
    const modal = document.getElementById("detailsModal");
    const openBtn = document.getElementById("showDetailsBtn");
    const closeBtn = document.querySelector(".close");

    openBtn.addEventListener("click", () => {
      populateRouteTable(tableData);
      modal.style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
    
    // 嗜好パラメータ調整
    const prefModal = document.getElementById("preferenceModal");
    const prefBtn = document.getElementById("preferenceBtn");
    const closePref = document.getElementById("closePrefModal");
    
    prefBtn.addEventListener("click", () => {
      prefModal.style.display = "block";
    });
    
    // 嗜好パラメータ閉じる
    closePref.addEventListener("click", () => {
      prefModal.style.display = "none";
    });
    window.addEventListener("click", (e) => {
      if (e.target === prefModal) prefModal.style.display = "none";
    });
    
    // スライダー値をリアルタイム表示
    for (let i = 1; i <= 5; i++) {
      const slider = document.getElementById(`pref${i}`);
      const display = document.getElementById(`pref${i}Value`);
      slider.addEventListener("input", () => {
        display.textContent = slider.value;
      });
    }
    
    // 保存ボタンで値を取得して閉じる
    const savePrefBtn = document.getElementById("savePrefBtn");
    let preferenceValues = [1,1,1,1,1]; // デフォルト
    savePrefBtn.addEventListener("click", () => {
      for (let i = 1; i <= 5; i++) {
        preferenceValues[i-1] = parseInt(document.getElementById(`pref${i}`).value);
      }
      console.log("嗜好パラメータ:", preferenceValues);
      prefModal.style.display = "none";
    });
  </script>
</body>
</html>
