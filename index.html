<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ルート表示（ローカルJSON使用版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: "Noto Sans JP", system-ui, sans-serif; margin: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Google Maps JavaScript API（geometryライブラリを必ず指定） -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCy2qRJaqSJ7TsZFB3u23Bk_EAFNrnMs28&libraries=geometry" async defer></script>

  <script>
  let map;
  let routes = {};   // すべてのルートデータを格納
  let polylines = []; // 現在表示中のポリラインを保持（消去用）

  // JSONファイルをまとめて読み込む
  async function loadAllRoutes() {
    const parts = 10; // routes_part1.json ~ routes_part9.json
    for (let k = 1; k <= parts; k++) {
      const resp = await fetch(`routes_part${k}.json`);
      const data = await resp.json();
      Object.assign(routes, data);
    }
    console.log("全ルート読み込み完了:", Object.keys(routes).length, "件");
  }

  // 地図初期化
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 36.695, lng: 137.213 }, // 適宜調整
      zoom: 10,
    });
  }

  // 折れ線を描画
  function drawRouteOnMap(order) {
    if (!map) {
      console.warn("地図がまだ初期化されていません");
      return;
    }
    if (!routes || Object.keys(routes).length === 0) {
      console.warn("ルートデータが未ロードです");
      return;
    }

    // 既存の線を消去
    polylines.forEach(pl => pl.setMap(null));
    polylines = [];

    // 指定された順序でルートを描画
    for (let i = 1; i < order.length; i++) {
      const a = Math.min(order[i - 1], order[i]);
      const b = Math.max(order[i - 1], order[i]);
      const key = `${a}_${b}`;
      const polyStr = routes[key];
      if (!polyStr) {
        console.warn("ルートデータなし:", key);
        continue;
      }
      const path = google.maps.geometry.encoding.decodePath(polyStr);
      const polyline = new google.maps.Polyline({
        path,
        strokeColor: "#FF0000",
        strokeOpacity: 0.8,
        strokeWeight: 4,
        map
      });
      polylines.push(polyline);
    }
  }

  // ページ読み込み後の処理
  window.addEventListener("load", async () => {
    initMap();
    await loadAllRoutes();

    // ★テスト表示（1→15→16→20 の順）
    drawRouteOnMap([1, 15, 16, 20]);
  });
  </script>
</body>
</html>
